<script type="text/javascript" src="/ueditor/ueditor.config.js"></script>
<script type="text/javascript" src="/ueditor/ueditor.all.js"></script>
<script type="text/javascript" src="/ueditor/lang/zh-cn/zh-cn.js"></script>
<script type="text/javascript" src="/ueditor/third-party/codemirror/codemirror.js"></script>
<script type="text/javascript" src="/ueditor/third-party/zeroclipboard/ZeroClipboard.js"></script>

<div class="layuimini-main">
    <div class="layui-form layuimini-form">
        <div class="layui-form-item">
            <label class="layui-form-label required">栏目名</label>
            <div class="layui-input-block">
                <input id="catename" type="text" name="name" lay-verify="required" lay-reqtext="栏目名不能为空" placeholder="请输入栏目名" value="" class="layui-input">
            </div>
        </div>
        <label class="layui-form-label">文章内容：</label>
        <div class="layui-input-block">
            <textarea class="layui-textarea layui-hide" name="content" lay-verify="content" id="cate-template"></textarea>
        </div>
<!--        <div class="layui-form-item">-->
<!--            <label class="layui-form-label">栏目模版</label>-->
<!--            <div class="layui-input-block" id="cate-template" name="category_template">-->
<!--            </div>-->
<!--        </div>-->
        <div class="layui-form-item">
            <label class="layui-form-label">稿件模版</label>
            <div class="layui-input-block" id="article-template" name="article_template" style="height: 400px">
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block" style="text-align: center">
                <button class="layui-btn layui-btn-normal" lay-submit lay-filter="saveBtn">确认保存</button>
            </div>
        </div>
    </div>
</div>
<script>
    layui.use(['form', 'table', 'layedit'], function () {
        var form = layui.form,
            layer = layui.layer,
            table = layui.table,
            layedit = layui.layedit,
            $ = layui.$;


        // var serverUrl = '/admin/ueditor/upload';
        // var ue_cate = UE.getEditor('cate-template', {'serverUrl': serverUrl});
        // var ue_article = UE.getEditor('article-template', {'serverUrl': serverUrl});

        //创建一个编辑器
        layedit.set({
            uploadImage: {
                url: 'test' //接口url
            }
        });
        var editIndex = layedit.build('cate-template', {
            tool: ['strong' //加粗
                , 'italic' //斜体
                , 'underline' //下划线
                , 'del' //删除线
                , '|' //分割线
                , 'left' //左对齐
                , 'center' //居中对齐
                , 'right' //右对齐
                , 'link' //超链接
                , 'unlink' //清除链接
                , 'image' //插入图片
            ],
            height: 100
        });

        // 来自父窗口的id
        var _id = window._id;
        var _event = window._event;

        // 编辑页面，加载栏目信息
        if(_event == 'edit'){
            $.get('/admin/category/info?id=' + _id, function (data){
                if(data.errcode != 0){
                    layer.alert(data.errmessage);
                    return;
                }

                $('#catename').val(data.data.info.name);
                if(data.data.info.template){
                    ue_cate.ready(function (){
                        this.setContent(data.data.info.template.category_template);
                    });
                    ue_article.ready(function (){
                        this.setContent(data.data.info.template.article_template);
                    });
                }
            });
        }

        /**
         * 初始化表单，要加上，不然刷新部分组件可能会不加载
         */
        form.render();

        // 当前弹出层，防止ID被覆盖
        var parentIndex = layer.index;
        console.log(parentIndex);

        //监听提交
        form.on('submit(saveBtn)', function (data) {
            // 来自父窗口的id
            // console.log(_id);

            var req;
            req = data.field;
            req.category_template = ue_cate.getContent();
            req.article_template = ue_article.getContent();
            console.log(req);

            var url;
            if(_event == 'edit'){
                url = '/admin/category/edit';
                req.id = _id;
            }else{
                url = '/admin/category/add';
            }

            $.post(url, req, function (data){
                if(data.errcode != 0){
                    layer.alert(data.errmessage);
                    return;
                }

                layer.msg("提交成功");
            });


            return false;
        });

    });
</script>